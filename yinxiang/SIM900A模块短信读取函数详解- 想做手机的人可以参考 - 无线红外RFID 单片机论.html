<html>
<head>
  <title>SIM900A模块短信读取函数详解- 想做手机的人可以参考 - 无线/红外/RFID 单片机论坛</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/304720 (zh-CN, DDL); Windows/6.1.7601 Service Pack 1 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="723"/>
<h1>SIM900A模块短信读取函数详解- 想做手机的人可以参考 - 无线/红外/RFID 单片机论坛</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2017/4/13 14:16</i></td></tr>
<tr><td><b>来源：</b></td><td><a href="http://www.51hei.com/bbs/dpj-30517-1.html"><i>http://www.51hei.com/bbs/dpj-30517-1.html</i></a></td></tr>
</table>
</div>
<br/>

<div><span><div style="-evernote-webclip:true"><br/><div style="font-size: 16px; display: inline-block;"><div style="word-wrap:break-word;"><div style="word-wrap:break-word;background:url(&quot;../../static/image/common/background.png&quot;) 0px 0px repeat-x rgb(255, 255, 255);font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:12px;line-height:1.5;font-family:Tahoma, &quot;Microsoft Yahei&quot;, Simsun;color:rgb(37, 37, 37);"><div style="word-wrap:break-word;"><div style="word-wrap:break-word;zoom:1;"><div style="word-wrap:break-word;background:rgb(255, 255, 255);"><div style="word-wrap:break-word;"><table style="font-size:inherit;font-weight:inherit;font-style:inherit;font-variant:inherit;word-wrap:break-word;empty-cells:show;"><tbody style="word-wrap:break-word;"><tr style="word-wrap:break-word;"><td style="word-wrap:break-word;vertical-align:top;">
<div style="word-wrap:break-word;overflow:hidden;margin-bottom:10px;padding:10px 0px;height:16px;border-bottom:1px dashed rgb(205, 205, 205);">
<div style="word-wrap:break-word;">
<div style="word-wrap:break-word;float:right;margin:-5px 10px 0px 0px;">
</div>
<div style="word-wrap:break-word;">
<img src="SIM900A模块短信读取函数详解- 想做手机的人可以参考 - 无线红外RFID 单片机论_files/online_member.gif" type="image/gif" height="16" style="word-wrap:break-word;vertical-align:middle;cursor:pointer;width:16px;" width="16"/>
<a href="http://www.51hei.com/bbs/space-uid-72008.html" style="word-wrap:break-word;text-decoration:none;color:rgb(51, 102, 153);" target="_blank">liuyy</a>
<em style="word-wrap:break-word;font-style:normal;">发表于 2015-1-12 14:42</em>
<span style="word-wrap:break-word;margin:0px 5px;color:rgb(204, 204, 204);">|</span>
<a href="http://www.51hei.com/bbs/dpj-30517-1.html" rel="nofollow" style="word-wrap:break-word;color:rgb(51, 51, 51);text-decoration:none;">显示全部楼层</a>

</div>
</div>
</div><div style="word-wrap:break-word;padding-bottom:1em;"><div style="word-wrap:break-word;background:url(&quot;../../static/image/common/ad.gif&quot;) 0px 50% no-repeat;margin-bottom:6px;padding-left:20px;zoom:1;">


</div><div style="word-wrap:break-word;clear:left;margin-right:0px;">
 
<div style="word-wrap:break-word;min-height:100px;">
<table cellpadding="0" cellspacing="0" style="font-size:inherit;font-weight:inherit;font-style:inherit;font-variant:inherit;word-wrap:break-word;empty-cells:show;border-collapse:collapse;table-layout:fixed;width:100%;"><tbody style="word-wrap:break-word;"><tr style="word-wrap:break-word;"><td style="word-wrap:break-word;font-size:14px;">
       经过两天的时间，一共分析了两个函数：手机拨接电话和手机读取短信函数。这两天tmd除了吃饭，睡觉和跑步外，时间全部耗在这上面了。不过收获也很大，关键是字符和字符串处理方面的知识收获较大。现在终于可以完工了，将自己的心血注释奉献出来，以供同道中人参考；当然要与原子的SIM900A模块程序其它源码对应才有意义。<br style="word-wrap:break-word;"/>
<br style="word-wrap:break-word;"/>
///////////////////////////////////////////////////////// //短信测试部分代码：<br style="word-wrap:break-word;"/>
<br style="word-wrap:break-word;"/>
//SIM900A读短信测试<br style="word-wrap:break-word;"/>
void sim900a_sms_read_test(void)<br style="word-wrap:break-word;"/>
{ <br style="word-wrap:break-word;"/>
        u8 *p,*p1,*p2;<br style="word-wrap:break-word;"/>
        u8 timex=0;<br style="word-wrap:break-word;"/>
        u8 msgindex[3];<br style="word-wrap:break-word;"/>
        u8 msglen=0;<br style="word-wrap:break-word;"/>
        u8 msgmaxnum=0;                //短信最大条数<br style="word-wrap:break-word;"/>
        u8 key=0;<br style="word-wrap:break-word;"/>
        u8 smsreadsta=0;        //是否在短信显示状态<br style="word-wrap:break-word;"/>
        p=mymalloc(SRAMIN,200);//申请200个字节的内存<br style="word-wrap:break-word;"/>
        LCD_Clear(WHITE); <br style="word-wrap:break-word;"/>
        POINT_COLOR=RED;<br style="word-wrap:break-word;"/>
        Show_Str_Mid(0,30,&quot;ATK-SIM900A 读短信测试&quot;,16,240);                                             <br style="word-wrap:break-word;"/>
        Show_Str(30,50,200,16,&quot;读取:     总信息:&quot;,16,0);         <br style="word-wrap:break-word;"/>
        kbd_fn_tbl[0]=&quot;读取&quot;;<br style="word-wrap:break-word;"/>
        kbd_fn_tbl[1]=&quot;返回&quot;; <br style="word-wrap:break-word;"/>
        sim900a_load_keyboard(0,180,(u8**)kbd_tbl1);//显示键盘  <br style="word-wrap:break-word;"/>
        while(1)<br style="word-wrap:break-word;"/>
        {<br style="word-wrap:break-word;"/>
                key=sim900a_get_keynum(0,180);<br style="word-wrap:break-word;"/>
                if(key)  /* 下面的操作都是基于触摸键有被按下  */<br style="word-wrap:break-word;"/>
                { /*△*/ <br style="word-wrap:break-word;"/>
                        if(smsreadsta)/*一旦读取到短信内容，即LCD上显示读取到的短信内容，这时按任意键都会清除显示的短信内容*/<br style="word-wrap:break-word;"/>
                        {<br style="word-wrap:break-word;"/>
                                LCD_Fill(30,75,239,179,WHITE);/*清除显示的短信内容*/<br style="word-wrap:break-word;"/>
                                smsreadsta=0;<br style="word-wrap:break-word;"/>
                        }<br style="word-wrap:break-word;"/>
                        if(key&lt;10||key==11)/* key11对应“0”，key&lt;10对应“1-9”号键 */<br style="word-wrap:break-word;"/>
                        {<br style="word-wrap:break-word;"/>
                                if(msglen&lt;2) /*“msglen&lt;2”确保读取的短信数小于100；即msgindex[0]和msgindex[1];因为一共只有50条短信  */<br style="word-wrap:break-word;"/>
                                {/*msgindex[msglen]短信索引号，即告诉模块想要读哪条短信，首次进入时msglen==0，执行msglen++（msglen++是后自增，其整体的值是msglen加1之前的值，如：int i=3；int j=i++；这时j的值是3，i的值是4；也就是说这时 msgindex[msglen++]==msgindex[0]，msglen则等于1；所以msgindex[0]= kbd_tbl[key-1][0]; 假设首次按下“8”，这时msglen++==0，所以msgindex[0]= 8；当再按下“8”时，则执行msglen++==1，msglen==2，msgindex[1]=8；因为这时msglen==2，所以执行下面的if(msglen==2)语句；即得出key值*/<br style="word-wrap:break-word;"/>
                                   msgindex[msglen++]=kbd_tbl[key-1][0];<br style="word-wrap:break-word;"/>
                    /* 本句等价于msgindex[msglen++]=*kbd_tbl[key-1]; */<br style="word-wrap:break-word;"/>
                                   u2_printf(&quot;AT+CLDTMF=2,\&quot;%c\&quot;\r\n&quot;,kbd_tbl[key-1][0]); <br style="word-wrap:break-word;"/>
                 /* 本句等价于u2_printf(&quot;AT+CLDTMF=2,\&quot;%c\&quot;\r\n&quot;,*kbd_tbl[key-1]); */<br style="word-wrap:break-word;"/>
                                }  /* &quot;AT+CLDTMF=2&quot;命令，测试DTMF音，时长2秒 ，将命令和键值发送给模块，同时每隔2s都会有返回值<br style="word-wrap:break-word;"/>
                        功能：每拨一个数字键（只对0-9号数字键有效）耳机得到模块返回的发出相应的拨号音*/<br style="word-wrap:break-word;"/>
                                if(msglen==2)<br style="word-wrap:break-word;"/>
                                {/* “msgindex[0]-'0'”短信“十位”数；“msgindex[1]-'0'”个位数 */<br style="word-wrap:break-word;"/>
                                        key=(msgindex[0]-'0')*10 + msgindex[1]-'0';<br style="word-wrap:break-word;"/>
       /* key键值等于“十位”加“个位”之和；确保key的取值范围在0-99！字符与字符相减，就是他们的ASCII码相减，得到整数值，<br style="word-wrap:break-word;"/>
                                                 得到一个比较值，就是谁前谁后; 例如 'c'-'a' 的就是：2*/<br style="word-wrap:break-word;"/>
                                        if(key&gt;msgmaxnum)<br style="word-wrap:break-word;"/>
                                        { /* msgmaxnum是短信最多条数值，该值的大小由模块查询可知 */<br style="word-wrap:break-word;"/>
                                          msgindex[0]=msgmaxnum/10+'0';/*这里“+'0'”的意思是字符“0”，在LCD上以十进制显示*/<br style="word-wrap:break-word;"/>
                                          msgindex[1]=msgmaxnum%10+'0'; /*只要用了单引号' '，这就是一个字符。50对10取余结果为0*/<br style="word-wrap:break-word;"/>
                                        }/* 这种算法记住！ */<br style="word-wrap:break-word;"/>
                                } <br style="word-wrap:break-word;"/>
                        }else<br style="word-wrap:break-word;"/>
                        {<br style="word-wrap:break-word;"/>
                                if(key==13)if(msglen)msglen--;//删除  <br style="word-wrap:break-word;"/>
                                if(key==14&amp;&amp;msglen)//执行读取短信<br style="word-wrap:break-word;"/>
                                { <br style="word-wrap:break-word;"/>
                                  LCD_Fill(30,75,239,179,WHITE);//清除之前的显示                    <br style="word-wrap:break-word;"/>
                                  sprintf((char*)p,&quot;AT+CMGR=%s&quot;,msgindex);/*AT+CMGR=3的意思是，向sim卡读取3号短信命令*/<br style="word-wrap:break-word;"/>
 /* sprintf（）函数的意思是将AT+CMGR=msgindex指令存储在P指针，并将AT+CMGR=msgindex以字符串形式发送给串口以实现向sim卡发送读取3号短信命令，本例中sprintf（）函数非常重要，在这里相当于执行了向sim900a模块发送字符串（即命令）任务，实际上就是把P的内容发送给串口USART2_TX_DATA寄存器*/<br style="word-wrap:break-word;"/>
                                 if(sim900a_send_cmd(p,&quot;+CMGR:&quot;,200)==0)/*读取短信，以下都是基于cpu收到了来自模块的返回值*/<br style="word-wrap:break-word;"/>
                                  { /*第一次发送AT+CMGR=2(即msgindex值)的时候，SIM900A模块返回的是（省略了多余的回车换行和“OK”等字符串，下同）：+CMGR: &quot;REC UNREAD&quot;,&quot;+8613560491039&quot;,&quot;@ZF&quot;,&quot;13/05/01,16:06:53+32&quot;00410054004B002D00530049004D00390030003000414E2D82F1658777ED4FE16D4B8BD50020  */<br style="word-wrap:break-word;"/>
                                                POINT_COLOR=RED;<br style="word-wrap:break-word;"/>
                                                Show_Str(30,75,200,12,&quot;状态:&quot;,12,0);<br style="word-wrap:break-word;"/>
                                                Show_Str(30+75,75,200,12,&quot;来自:&quot;,12,0);<br style="word-wrap:break-word;"/>
                                                Show_Str(30,90,200,12,&quot;接收时间:&quot;,12,0);<br style="word-wrap:break-word;"/>
                                                Show_Str(30,105,200,12,&quot;内容:&quot;,12,0);<br style="word-wrap:break-word;"/>
                                                POINT_COLOR=BLUE;<br style="word-wrap:break-word;"/>
                                                if(strstr((const char*)(USART2_RX_BUF),&quot;UNREAD&quot;)==0)<br style="word-wrap:break-word;"/>
                          /* 其中：&quot;REC UNREAD&quot;，表示该短信没有被读取过，也就是未读短信。  */<br style="word-wrap:break-word;"/>
                          Show_Str(30+30,75,200,12,&quot;已读&quot;,12,0);<br style="word-wrap:break-word;"/>
                                                else Show_Str(30+30,75,200,12,&quot;未读&quot;,12,0);<br style="word-wrap:break-word;"/>
                                                p1=(u8*)strstr((const char*)(USART2_RX_BUF),&quot;,&quot;);<br style="word-wrap:break-word;"/>
                                                p2=(u8*)strstr((const char*)(p1+2),&quot;\&quot;&quot;);<br style="word-wrap:break-word;"/>
                                                p2[0]=0;//加入结束符<br style="word-wrap:break-word;"/>
                                                sim900a_unigbk_exchange(p1+2,p,0);        /*将unicode字符转换为gbk码  */<br style="word-wrap:break-word;"/>
                                                Show_Str(30+75+30,75,200,12,p,12,0);        //显示电话号码<br style="word-wrap:break-word;"/>
                                                p1=(u8*)strstr((const char*)(p2+1),&quot;/&quot;);<br style="word-wrap:break-word;"/>
                                                p2=(u8*)strstr((const char*)(p1),&quot;+&quot;);<br style="word-wrap:break-word;"/>
                                                p2[0]=0;//加入结束符<br style="word-wrap:break-word;"/>
                                                Show_Str(30+54,90,200,12,p1-2,12,0);/*显示接收时间  */<br style="word-wrap:break-word;"/>
                                                p1=(u8*)strstr((const char*)(p2+1),&quot;\r&quot;); /*寻找回车符*/<br style="word-wrap:break-word;"/>
                                                sim900a_unigbk_exchange(p1+2,p,0);        /*将unicode字符转换为gbk码*/<br style="word-wrap:break-word;"/>
                                                Show_Str(30+30,105,180,75,p,12,0);        /*显示短信内容*/<br style="word-wrap:break-word;"/>
                                                smsreadsta=1;         /*标记有显示短信内容，这时按任意键都会清除显示的短信内容 */<br style="word-wrap:break-word;"/>
                                  }else<br style="word-wrap:break-word;"/>
                                        {<br style="word-wrap:break-word;"/>
                                                Show_Str(30,75,200,12,&quot;无短信内容!!!请检查!!&quot;,12,0);<br style="word-wrap:break-word;"/>
                                                delay_ms(1000);<br style="word-wrap:break-word;"/>
                                                LCD_Fill(30,75,239,75+12,WHITE);//清除显示<br style="word-wrap:break-word;"/>
                                        }          <br style="word-wrap:break-word;"/>
                                        USART2_RX_STA=0;<br style="word-wrap:break-word;"/>
                                }<br style="word-wrap:break-word;"/>
                                if(key==15)break;/*结束while循环回到短信收发界面*/<br style="word-wrap:break-word;"/>
                        } <br style="word-wrap:break-word;"/>
                        msgindex[msglen]=0; /*每拨一个短信索引号都在其后加一个结束符！本句很重要！字符串的结束符是'\0' 也是0；  */<br style="word-wrap:break-word;"/>
                        LCD_Fill(30+40,50,86,50+16,WHITE);  /* */<br style="word-wrap:break-word;"/>
                        Show_Str(30+40,50,86,16,msgindex,16,0);  /*显示要读取sim卡中短信索引号即要读取几号短信*/          <br style="word-wrap:break-word;"/>
                } /*△*/   /*数组名msgindex代表整个msgindex数组空间，即显示整个msgindex空间内容 */<br style="word-wrap:break-word;"/>
                if(timex==0)                //2.5秒左右更新一次<br style="word-wrap:break-word;"/>
                {<br style="word-wrap:break-word;"/>
                        if(sim900a_send_cmd(&quot;AT+CPMS?&quot; , &quot;+CPMS:&quot;,200)==0)  /* 查询优选消息存储器 */<br style="word-wrap:break-word;"/>
                        { /* AT+CPMS，用于查询/设置优选消息存储器，通过发送：AT+CPMS?，可以查询当前SIM卡最大支持多少条短信存储，<br style="word-wrap:break-word;"/>
       以及当前存储了多少条短信等信息。如发送AT+CPMS?命令返回：+CPMS: &quot;SM&quot;,21,50,&quot;SM&quot;,21,50,21是指已经一共有了21条短信，50是指最大能存储50条短信 */<br style="word-wrap:break-word;"/>
                                p1=(u8*)strstr((const char*)(USART2_RX_BUF),&quot;,&quot;); /*P1指向第一个逗号 */<br style="word-wrap:break-word;"/>
                                p2=(u8*)strstr((const char*)(p1+1),&quot;,&quot;);/* P2指向第二个逗号 */<br style="word-wrap:break-word;"/>
                                p2[0]='/'; /* 将P2指针的第一个字符赋值为'/'以在LCD上显示出来,p2[1]='5',p2[2]='0', p2[3]==',' ；   */<br style="word-wrap:break-word;"/>
                                if(p2[3]==',')/* 小于64K SIM卡，最多存储几十条短信 */<br style="word-wrap:break-word;"/>
                                {/* if(p2[3]==',')语句的意思：  */<br style="word-wrap:break-word;"/>
                                        msgmaxnum=(p2[1]-'0')*10+p2[2]-'0'; /* 获取最大存储短信条数50 */<br style="word-wrap:break-word;"/>
                                        p2[3]=0;  /* 加入结束符,目的是为了在LCD上显示&quot;21/50&quot; ；有了这个结束符可以推出：P1+1的内容是&quot;21/50&quot;  */<br style="word-wrap:break-word;"/>
                                }else /* 如果是64K SIM卡，则能存储100条以上的信息 */<br style="word-wrap:break-word;"/>
                                {<br style="word-wrap:break-word;"/>
                                        msgmaxnum=(p2[1]-'0')*100+(p2[2]-'0')*10+p2[3]-'0';//获取最大存储短信条数<br style="word-wrap:break-word;"/>
                                        p2[4]=0;<br style="word-wrap:break-word;"/>
                                }  /* 这种字符串的与字符的取值方法值得学习，必须温故！    */<br style="word-wrap:break-word;"/>
                                sprintf((char*)p,&quot;%s&quot;,p1+1); /* 将指针“P1+1”的字符串存储到P，P1+1的内容是&quot;21/50&quot; */<br style="word-wrap:break-word;"/>
                                Show_Str(30+17*8,50,200,16,p,16,0);  /* 显示sim卡一共已存储短信数 ，如显示：21/50  */<br style="word-wrap:break-word;"/>
                                USART2_RX_STA=0;        /* 重新准备接受数据 */        <br style="word-wrap:break-word;"/>
                        }<br style="word-wrap:break-word;"/>
                }        <br style="word-wrap:break-word;"/>
                if((timex%20)==0)LED0=!LED0;//200ms闪烁 <br style="word-wrap:break-word;"/>
                timex++;<br style="word-wrap:break-word;"/>
                delay_ms(10);<br style="word-wrap:break-word;"/>
                if(USART2_RX_STA&amp;0X8000)sim_at_response(1);/*检查从GSM模块接收到的数据，不断扫描接收来自模块的返回值 */<br style="word-wrap:break-word;"/>
        }<br style="word-wrap:break-word;"/>
        myfree(SRAMIN,p); <br style="word-wrap:break-word;"/>
}<br style="word-wrap:break-word;"/>
<br style="word-wrap:break-word;"/>
该睡觉了！<br style="word-wrap:break-word;"/>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <br style="word-wrap:break-word;"/>
<br style="word-wrap:break-word;"/>
</td></tr></tbody></table>

<div style="word-wrap:break-word;padding-left:20px;background:url(&quot;../../static/image/common/tag.gif&quot;) 0px 2px no-repeat;margin-top:5px;margin-bottom:10px;">
<a href="http://www.51hei.com/bbs/misc.php?mod=tag&amp;id=842" style="word-wrap:break-word;text-decoration:none;color:rgb(51, 102, 153);" target="_blank" title="字符串">字符串</a>, <a href="http://www.51hei.com/bbs/misc.php?mod=tag&amp;id=1228" style="word-wrap:break-word;text-decoration:none;color:rgb(51, 102, 153);" target="_blank" title="短信">短信</a>, <a href="http://www.51hei.com/bbs/misc.php?mod=tag&amp;id=122" style="word-wrap:break-word;text-decoration:none;color:rgb(51, 102, 153);" target="_blank" title="手机">手机</a>, <a href="http://www.51hei.com/bbs/misc.php?mod=tag&amp;id=10" style="word-wrap:break-word;text-decoration:none;color:rgb(51, 102, 153);" target="_blank" title="程序">程序</a>, <a href="http://www.51hei.com/bbs/misc.php?mod=tag&amp;id=501" style="word-wrap:break-word;text-decoration:none;color:rgb(51, 102, 153);" target="_blank" title="电话">电话</a></div>

</div>
<div style="word-wrap:break-word;">
</div>

<div style="word-wrap:break-word;"></div>

<div style="word-wrap:break-word;"></div>
</div>
</div>

</td></tr></tbody></table></div></div></div></div></div></div></div><br/></div></span>
</div></body></html> 